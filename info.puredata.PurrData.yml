id: info.puredata.PurrData
runtime: org.freedesktop.Platform
runtime-version: '19.08'
sdk: org.freedesktop.Sdk
default-branch: stable
command: pd-wrapper.sh
finish-args: [
    # Display
    '--share=ipc', '--socket=x11', '--socket=wayland', '--device=dri',
    # Audio access
    '--socket=pulseaudio',
    # Filesystem access (pd doesn't yet work with portals)
    '--filesystem=host',
    '--filesystem=home',
    # MIDI access (Flatpak doesn't yet support exposing only MIDI devices)
    '--device=all'
]
modules:
- name: purr-data
  sources:
  - type: git
    # This fork of https://github.com/agraef/purr-data/ simply removes the Gem
    # submodule, as it took way too long to clone this submodule for me.
    url: https://github.com/ssssam/purr-data
    branch: sam/2.10.0-disable-gem
  - type: patch
    path: patch/build-api.patch
  - type: patch
    path: patch/no-rsync-during-install.patch
  - type: file
    # Using an binary x86_64 build of nw.js makes me sad. There are ARM packages
    # available from the nw.js website. For other platforms, it's difficult but
    # possible to build nw.js and Chromium from source, good luck!
    url: https://dl.nwjs.io/v0.42.3/nwjs-v0.42.3-linux-x64.tar.gz
    sha256: 4802a3a32767ff8908aef8e91e11d81e7b515b32a09c9ab82c09edf91e49d99e
    dest-filename: nwjs.tar.gz
  - type: file
    path: ./pd-wrapper.sh
  - type: file
    path: ./data/info.puredata.PurrData.desktop
  - type: file
    path: ./data/icons/info.puredata.PurrData.svg
  buildsystem: autotools
  subdir: pd/src
  config-opts: [ '--disable-portaudio', '--disable-alsa', '--enable-oss' ]
  post-install:
  # These commands run in the 'subdir' that we set, but the sources appear at
  # the top level hence the `../..` everywhere.
  - mkdir -p /app/lib/pd-l2ork/bin/nw
  - tar -x -f ../../nwjs.tar.gz -C /app/lib/pd-l2ork/bin/nw --strip-components=1
  - install -m 755 ../../pd-wrapper.sh /app/bin
  - install -d /app/share/applications/
  - install -m 644 ../../info.puredata.PurrData.desktop /app/share/applications/
  - install -d /app/share/icons/hicolor/scalable/apps
  - install -m 644 ../../info.puredata.PurrData.svg /app/share/icons/hicolor/scalable/apps/
